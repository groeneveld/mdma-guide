# CLAUDE.md

LaTeX-based academic book project for MDMA-assisted psychotherapy manual with automated glossary processing, multi-format output (PDF/EPUB/Markdown/MediaWiki), and comprehensive build automation.

**Important:** If you need to build the project, ask me to do it. Build output is verbose and uses unnecessary tokens.

## Build Commands

**Standard Workflow:**
- `./build.sh` - Build PDF (gls.py preprocessing → latexmk with lualatex/biber/makeglossaries → outputs to temp/ → moves PDF to root)
- `./clear.sh` - Clean all build artifacts (latexmk -C, biber cache, temp/, generated files). Used when ./build.sh fails for unclear reasons.
- If build fails: `./clear.sh && ./build.sh`

**Alternative Formats:**
- `./epub.sh` - Generate EPUB3 (expand_refs.py → pandoc with Nature CSL style)
- `./md.sh` - Extract markdown summary between BEGIN_PLAIN_SUMMARY/END_PLAIN_SUMMARY markers (converts \mdcite to \citep, uses APA CSL)
- `cd wiki && ./wiki.sh <input>.tex` - Convert to MediaWiki format (pre-wiki.py → pandoc → to-wiki-refs.py with CS1 citations)

## Files & Directories

**Primary Documents:**
- `paper.tex` - Primary source (processed by gls.py to generate Open MDMA.tex)
- `glossary.tex` - Glossary term definitions with stems
- `references.bib` - Bibliography database

**Never Edit (Auto-Generated):**
- `Open MDMA.tex` - Generated by gls.py
- `Open MDMA.pdf` - Build output
- `temp/*` - Build artifacts

**Key Directories:**
- `auxillaryFiles/` - Scripts (gls.py, citation utilities), styles (CSL, CSS), graphics (cover.pdf, mdma.svg/pdf), chemical structures
- `wiki/` - Wikipedia conversion pipeline (wiki.sh, pre-wiki.py, to-wiki-refs.py, example .tex files)
- `temp/` - Build artifacts (intermediate files, gitignored)
- `oavvalidationfigure2data/` - OAV validation data and Julia plotting scripts
- `liechtiGenderTable/` - Gender pharmacokinetic data

**Build Pipeline:**
- `gls.py` - Reads glossary.tex, processes paper.tex section-by-section, replaces first term occurrences with \glsdisp, generates Open MDMA.tex

## Technical Notes

**Dependencies:** LaTeX (lualatex, latexmk, biber, makeglossaries), Python 3, pandoc (optional)

**Glossary Behavior:**
- One replacement per term per section
- Skips headings, citations, labels, "Quick Start / Essentials" section
- Terms not replaced in their defining section